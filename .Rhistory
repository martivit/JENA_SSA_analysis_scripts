library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
source('1_preparation.R')
source('2_analysis.R')
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
source('1_preparation.R')
source('2_analysis.R')
data$overall <- "overall"
##------------------ define the disaggregation variables:  ------------------
group_vars <- c("overall", "Governorate", "Type of the School", "what is the Key informant type?", "What is the main source of drinking water provided by the school? (Select most frequently used)")
group_vars <- c(group_vars,"Governorate, What is the main source of drinking water provided by the school? (Select most frequently used)")
columns_to_exclude <- c('Sub-District', 'Community', 'School name')
## create the list of analysis LOA
so_loa_analysis <- expand.grid(
analysis_var = indicator_so,
analysis_type = "prop_select_one",
group_var = group_vars,
stringsAsFactors = FALSE
)
sm_loa_analysis <- expand.grid(
analysis_var = indicator_sm,
analysis_type = "prop_select_multiple",
group_var = group_vars,
stringsAsFactors = FALSE
)
int_loa_analysis <- expand.grid(
analysis_var = indicator_int,
analysis_type = "mean",
group_var = group_vars,
stringsAsFactors = FALSE
)
loa_analysis_combined <- dplyr::bind_rows(so_loa_analysis, sm_loa_analysis, int_loa_analysis)
loa_analysis_combined <- loa_analysis_combined[loa_analysis_combined$analysis_var != loa_analysis_combined$group_var, ]
loa_analysis_combined <- loa_analysis_combined %>%
filter(!(analysis_var %in% columns_to_exclude))
View(loa_analysis_combined)
result <- create_analysis(
srvyr::as_survey(data),
loa = loa_analysis_combined,
sm_separator =  "/")
loa_analysis_combined <- dplyr::bind_rows(so_loa_analysis, sm_loa_analysis, int_loa_analysis)
loa_analysis_combined <- loa_analysis_combined[loa_analysis_combined$analysis_var != loa_analysis_combined$group_var, ]
loa_analysis_combined <- loa_analysis_combined[
!mapply(function(a, g) grepl(a, g, fixed = TRUE),
loa_analysis_combined$analysis_var,
loa_analysis_combined$group_var),
]
loa_analysis_combined <- loa_analysis_combined %>%
filter(!(analysis_var %in% columns_to_exclude))
result <- create_analysis(
srvyr::as_survey(data),
loa = loa_analysis_combined,
sm_separator =  "/")
## ------------------- organize output tables -----------
result_all<- result$results_table%>%
select(
analysis_type,
analysis_var,
analysis_var_value,
group_var,
group_var_value,
stat,
n,
n_total
)
## if labels where used instead of label do the following:
result_all <- result_all %>%
rename(
question = analysis_var,
choice = analysis_var_value
)
# Create a named list of filtered data frames
result_by_group <- lapply(group_vars, function(gv) {
result_all %>% filter(group_var == gv)
})
# Name the list elements with safe sheet names
names(result_by_group) <- make.names(group_vars, unique = TRUE)
# Write to Excel file with one sheet per group_var
write_xlsx(result_by_group, path = "output/results_ALL.xlsx")
View(result)
View(result[["results_table"]])
write_xlsx(result_all, path = "output/results_raw.xlsx")
## common
write_xlsx(result_all, path = "output/results_raw.xlsx")
group_vars <- unique(result_all$group_var)
# Step 4: Create a named list of filtered data frames
result_by_group <- lapply(group_vars, function(gv) {
result_all %>% filter(group_var == gv)
})
# Step 5: Clean sheet names (truncate and make safe/unique)
names(result_by_group) <- make.unique(substr(gsub("[^A-Za-z0-9]", "_", group_vars), 1, 28))
# Step 6: Write to Excel
write_xlsx(result_by_group, path = "output/results_ALL.xlsx")
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
source('1_preparation.R')
source('2_analysis.R')
# 1. Make sure devtools is available
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
# 2. Define your CRAN packages
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
# 3. Install missing CRAN packages
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
# 4. Install analysistools from GitHub if needed
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
# 5. Load all libraries
all_pkgs <- c(cran_pkgs, "analysistools")
invisible(lapply(all_pkgs, library, character.only = TRUE))
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
# 1. checking packages
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
R.version.string
install.packages("installr")
library(installr)
updateR()   # This will download, install, and help copy packages
install.packages("installr")
# 1. checking packages
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
update.packages(ask = FALSE, checkBuilt = TRUE)
warnings()
update.packages(ask = FALSE, checkBuilt = TRUE)
# 1. checking packages
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
R.version.string
install.packages("installr")
library(installr)
updateR()   # This will download, install, and help copy packages
# 1. checking packages
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
source('0_variable_definition.R') ## IMPORTANT to UPDATE: file paths and language-label / strata (and if names where used instead of label)
source('1_preparation.R')
source('2_analysis.R')
##------------------ filepath
dataset_path = 'input/SSA_Data 2025.xlsx'
dataset_sheet = 'SSA_questionnaire'
kobo_path = 'input/SSA_questionnaire.xlsx'
survet_sheet = 'survey'
choice_sheet = 'choices'
##------------------ column name/label
##IMPORTANT: define the column in the kobo that correspond to what has been used in the final dataset, either name or label
var_dataset_colums = 'label::English (en)'
##------------------ define the disaggregation variables:  ------------------
group_vars <- c("overall", "Governorate", "Type of the School", "what is the Key informant type?", "What is the main source of drinking water provided by the school? (Select most frequently used)")
group_vars <- c(group_vars,"Governorate, What is the main source of drinking water provided by the school? (Select most frequently used)")
columns_to_exclude <- c('Sub-District', 'Community', 'School name')
print (group_vars)
source('helpers.R')
# 1. checking packages
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
source('helpers.R')
source('0_variable_definition.R')
source('1_preparation.R')
# 1. checking packages
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
source('helpers.R')
source('0_variable_definition.R') ## IMPORTANT to UPDATE: file paths and language-label / strata (and if names where used instead of label)
source('1_preparation.R')
View(data)
names(data)
# 1. checking packages
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
source('helpers.R')
source('0_variable_definition.R') ## IMPORTANT to UPDATE: file paths and language-label / strata (and if names where used instead of label)
source('1_preparation.R')
View(data)
print(indicator_int)
# 1. checking packages
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
source('helpers.R')
source('0_variable_definition.R') ## IMPORTANT to UPDATE: file paths and language-label / strata (and if names where used instead of label)
source('1_preparation.R')
source('2_analysis.R')
# 1. checking packages
if (!requireNamespace("devtools", quietly = TRUE)) {
install.packages("devtools")
}
cran_pkgs <- c(
"writexl", "readr", "gdata", "tidyverse", "rlang",
"dplyr", "formattable", "data.table", "hablar",
"tidyr", "readxl", "purrr"
)
installed <- rownames(installed.packages())
to_install <- setdiff(cran_pkgs, installed)
if (length(to_install) > 0) {
install.packages(to_install, dependencies = TRUE)
}
if (!"analysistools" %in% installed) {
devtools::install_github("impact-initiatives/analysistools")
}
library(writexl)
library(readr)
library(gdata)
library(tidyverse)
library(rlang)
library(dplyr)
library(formattable)
library(data.table)
library(hablar)
library(tidyr)
library(readxl)
library(purrr)
library(analysistools)
source('helpers.R')
##------------------ upload dataset and kobo
data    <- read_excel(dataset_path , sheet = dataset_sheet)
##------------------ filepath  ------------------
dataset_path = 'input/SSA_Data 2025.xlsx'
dataset_sheet = 'SSA_questionnaire'
kobo_path = 'input/SSA_questionnaire.xlsx'
survet_sheet = 'survey'
choice_sheet = 'choices'
##------------------ column name/label  ------------------
##IMPORTANT: define the column in the kobo that correspond to what has been used in the final dataset, either name or label
var_dataset_colums = 'label::English (en)'
##------------------ define the disaggregation variables:  ------------------
# 1) strata
group_vars <- c("overall", "Governorate", "Type of the School", "what is the Key informant type?", "What is the main source of drinking water provided by the school? (Select most frequently used)")
# 2) combined strata
group_vars <- c(group_vars,"Governorate, What is the main source of drinking water provided by the school? (Select most frequently used)")
# 3) columns present in kobo that do not need to be calculated
columns_to_exclude <- c('Sub-District', 'Community', 'School name')
##------------------ define numerator/denominator indicators (ratios) ------------------
# 1) List the derived indicators you want to compute.
#    new_var:   name of the new column to create
#    numerator: column in your dataset to use as numerator
#    denominator: column in your dataset to use as denominator --> if sum is needed that create a +/- etc with the names of the columns "`C1` + `C2`"
#    scale:     multiply result by this (use 1 for ratios, 100 for %)
derived_specs <- tibble::tribble(
~new_var, ~numerator,                                   ~denominator,                                                                 ~scale,
"PTR",    "Total number of students within the school", "`How many teaching staff were there ? Male:` + `How many teaching staff were there ? Female:`",   1,
"PCR",    "Total number of students within the school", list("How many total classrooms are there at this school that are functioning? (used for lessons)"), 1
)
##------------------ define binary indicators (>=1 logic) ------------------
# new_var:  name of the new column
# source:   column to check
# condition: optional condition (default: ">= 1")
binary_specs <- tibble::tribble(
~new_var,                                      ~source,                                   ~condition,
"schools_with_window_replacement_needs",      "Number of windows that need replacement",  ">= 1",
"schools_with_toilet_repair_needs",           "Number of windows that need repairs",      ">= 1"
)
print(group_vars)
